// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.
//>>built
define(["dojo/Deferred"],function(h){var f=function(a,d,b){this._parentModule=a;this._worker=d;this._connection=b;this.msgCount=0;this.outgoingJobs={};this.incomingJobs={}};f.prototype.invoke=function(a,d,b,c){var e=++this.msgCount,g=new h(function(a){this._worker.postMessage({type:"\x3ccancel\x3e",id:e,connection:c,data:{reason:a}});this.outgoingJobs[e]&&delete this.outgoingJobs[e]}.bind(this));this.outgoingJobs[e]=g;this._worker.postMessage({type:a,id:e,connection:c,data:d},b);return g.promise};
f.prototype.message=function(a){if(a&&a.data){var d=a.data.type;if(d){var b=a.data,c=a.data.id,e=a.data.connection;if("\x3cresponse\x3e"===d&&c){if(a=this.outgoingJobs[c])delete this.outgoingJobs[c],b.error?a.reject(b.error):a.resolve(b.data)}else"\x3ccancel\x3e"===d&&c?(a=this.incomingJobs[c])&&a.cancel(b.data.reason):(a=this._parentModule[d],"function"===typeof a&&(b=a.call(this._parentModule,b.data,this._connection),this.incomingJobs[c]=b,b.then(function(a){this._worker.postMessage({type:"\x3cresponse\x3e",
id:c,connection:e,data:a.data},a.buffers)}.bind(this)).otherwise(function(a){a||(a="Error encountered at method "+d);(!a.dojoType||"cancel"!==a.dojoType)&&this._worker.postMessage({type:"\x3cresponse\x3e",id:c,connection:e,error:a})}.bind(this)).always(function(){delete this.incomingJobs[c]}.bind(this))))}}};return f});