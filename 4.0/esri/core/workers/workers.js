// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.
//>>built
define(["dojo/Deferred","dojo/promise/all","../promiseUtils","./Connection","./JobProxy"],function(h,k,g,l,m){var c=function(){var a=Math.max((navigator.hardwareConcurrency||2)-1,2);this.ready=!1;this._jobProxies=[];this._jobProxyReady=[];this._connectionIndex=this._currentWorkerId=0;this._connections={};this._connectionPromises={};for(var b=this._workerInitHandler.bind(this),e=0;e<a;++e){var f=new m(this._connections,e,b);this._jobProxies.push(f);this._jobProxyReady.push(!1)}};c.prototype.open=function(a,
b){return this._openConnection(a).then(function(a){return this._loadModule(b,a.id).then(function(){return a}).otherwise(function(a){return g.reject(a)})}.bind(this))};c.prototype.terminate=function(){for(var a=0;a<this._jobProxies.length;a++)this._jobProxies[a].terminate();this._jobProxies=[]};c.prototype.closeConnection=function(a){if(a)if(this._connections[a.id]&&delete this._connections[a.id],this.ready)for(var b=0;b<this._jobProxies.length;b++)this._jobProxies[b].closeConnection(a.id);else if(b=
this._connectionPromises[a.id])b.cancel(),delete this._connectionPromises[a.id]};c.prototype.invoke=function(a,b,e,f,c){var d=null;f&&(d=f.id);if(null===d&&(d=this._currentWorkerId=(this._currentWorkerId+1)%this._jobProxies.length,!this._jobProxyReady[d]&&!this._jobProxies.some(function(a,b,e){d=(d+1)%e.length;return this._jobProxyReady[d]}.bind(this))))return g.reject(Error("No worker available"));a=this._jobProxies[d].invoke(a,b,e,c);f&&(f.id=d);return a};c.prototype.broadcast=function(a,b,e,f){for(var c=
[],d=0;d<this._jobProxies.length;d++)this._jobProxyReady[d]&&c.push(this._jobProxies[d].invoke(a,b,e,f));return c};c.prototype._loadModule=function(a,b){for(var e=[],c=0;c<this._jobProxies.length;c++)e.push(this._jobProxies[c].openConnection(a,b));return k(e).then(function(a){for(var b in a)if(b.error)return g.reject(Error("failed to load module onto connection #"+b.connection+". Error: "+b.error))})};c.prototype._workerInitHandler=function(a){this._jobProxyReady[a]=!0;if(!this.ready&&this._jobProxyReady.every(function(a){return a})){for(var b in this._connectionPromises)(a=
this._connections[b])&&this._connectionPromises[b].resolve(a);this._connectionPromises={};this.ready=!0}};c.prototype._openConnection=function(a){var b=this._connectionIndex++;a=new l(a,b,this);this._connections[b]=a;var c=new h;this.ready?c.resolve(a):this._connectionPromises[b]=c;return c.promise};return new c});