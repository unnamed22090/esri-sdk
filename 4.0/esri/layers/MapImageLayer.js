// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.
//>>built
define("dojo/_base/lang dojo/io-query dojo/Deferred ../config ../request ../core/urlUtils ../core/promiseUtils ./DynamicLayer ./mixins/ArcGISDynamicService ./mixins/PortalLayer".split(" "),function(f,k,l,m,g,h,n,p,q,r){return p.createSubclass([q,r],{declaredClass:"esri.layers.MapImageLayer",portalLoaderModule:"portal/loaders/MapImageLayerLoader",normalizeCtorArgs:function(b,c){return"string"===typeof b?f.mixin({url:b},c):b},load:function(){this.addResolvingPromise(this.loadFromPortal(this._fetchService.bind(this)))},
properties:{alwaysRefetch:!1},getImageUrl:function(b,c){var a=this.parsedUrl.path+"/export",d=f.mixin({},this.parsedUrl.query,this.getExportImageParameters(b),{f:"image",token:this.token,_ts:this.alwaysRefetch?(new Date).getTime():null}),e=h.addProxy(a+"?"+k.objectToQuery(d));if(e.length>m.request.maxUrlLength){d.f="json";var s=this;g(a,{query:d,responseType:"json",callbackParamName:"callback"}).then(function(a){c(h.addProxy(a.data.href+"?token\x3d"+s.token))})}else c(e)},fetchImage:function(b){var c=
!1,a,d=new l(function(){c=!0;a&&(a=a.onload=a.onerror=a.onabort=null)});this.supportsRotation||delete b.rotation;this.getImageUrl(b,function(e){c||(a=document.createElement("img"),a.setAttribute("alt",""),a.setAttribute("width",b.width),a.setAttribute("height",b.height),a.onload=function(c){a.onload=a.onerror=a.onabort=null;d.resolve({options:b,img:a});a=null},a.onerror=a.onabort=function(b){a.onload=a.onerror=a.onabort=null;d.reject(Error("Unable to load image: "+a.src));a=null},a.src=e)});return d.promise},
_fetchService:function(){return n.resolve().then(function(){return this.resourceInfo||g(this.parsedUrl.path,{query:f.mixin({f:"json"},this.parsedUrl.query),responseType:"json",callbackParamName:"callback"})}.bind(this)).then(function(b){b.ssl&&(this.url=this.url.replace(/^http:/i,"https:"));this.read(b.data)}.bind(this))}})});