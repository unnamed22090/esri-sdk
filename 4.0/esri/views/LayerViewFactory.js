// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.
//>>built
define("dojo/_base/lang dojo/Deferred dojo/when ../core/Accessoire ../core/Error ../core/Collection ../core/watchUtils".split(" "),function(g,h,k,l,f,m,n){return l.createSubclass({declaredClass:"esri.views.LayerViewFactory",classMetadata:{properties:{creationRequests:{type:m},paused:{},working:{dependsOn:["paused","creationRequests.length"],readOnly:!0}}},getDefaults:function(){return g.mixin(this.inherited(arguments),{creationRequests:[]})},initialize:function(){n.whenFalse(this,"paused",function(){this.creationRequests.toArray().forEach(this._processRequest,
this)}.bind(this))},destroy:function(){this.creationRequests.drain(function(a){a.deferred.cancel()})},creationRequests:null,paused:!0,view:null,_workingGetter:function(){return 0<this.creationRequests.length},create:function(a,c){var d=this.getLayerViewPromise(c);if(d)return d;var e=this.creationRequests,b={deferred:new h(function(){var a=f("cancelled:layerview-create","layerview creation cancelled",{layer:c});e.remove(b);b.creationPromise&&b.creationPromise.cancel(a);return a}),view:a,layer:c,started:!1};
e.push(b);this.paused||this._processRequest(b);return b.deferred.promise},dispose:function(a){a.layer.destroyLayerView(a)},getLayerViewPromise:function(a){var c=this.creationRequests&&this.creationRequests.find(function(c){return c.layer===a});return c&&c.deferred.promise},_processRequest:function(a){if(!a.started){a.started=!0;var c=a.deferred,d=a.layer,e=a.view;d.load().then(function(b){if(!c.isCanceled())return a.creationPromise=b.createLayerView(e),a.creationPromise}).then(function(b){return!c.isCanceled()?
(a.creationPromise=k(b,function(a){return a.layerView?a.layerView:b}),a.creationPromise):b}).otherwise(function(a){c.isCanceled()||c.reject(f("layerview:create-error","layerview creation failed",{layer:d,error:a}))}).then(function(b){this.creationRequests&&this.creationRequests.remove(a);c.isFulfilled()?b&&this.dispose(b):c.resolve(b);return b}.bind(this))}}})});