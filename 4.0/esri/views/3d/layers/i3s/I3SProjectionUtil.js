// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.
//>>built
define(["../../support/projectionUtils","../../lib/glMatrix"],function(p,v){var e=v.vec3d,m=v.mat4d,u={PER_VERTEX:"perVertex",BOUNDINGBOX:"boundingBox",NO_REPROJECTION:"noReprojection"},l=new Float64Array(3E3);return{ReprojectionTypes:u,reprojectPoints:function(c,e,f,d,l,b,g,a){c===u.PER_VERTEX?d=this.reprojectPointsPerVertex(e,f,d,b,g,a,l):c===u.BOUNDINGBOX?d=this.reprojectBoundingBox(e,d,b,g,a):(c=m.create(),m.identity(c),e=m.create(),p.computeLinearTransformation(b,d,e,a),d={localTrafo:c,globalTrafo:e});
return d},reprojectPointsPerVertex:function(c,e,f,d,q,b,g){e=m.create();p.computeLinearTransformation(d,f,e,b);var a=m.create(),a=m.inverse(e,a),k=m.create();m.identity(k);if(!g){g=[0,0,0];var h=c.length/3;p.vectorToVector(f,d,g,q);for(d=f=0;d<h;d+=1E3){var n=Math.min(1E3,h-d);for(f=0;f<n;f++)l[3*f]=c[3*(d+f)]+g[0],l[3*f+1]=c[3*(d+f)+1]+g[1],l[3*f+2]=c[3*(d+f)+2]+g[2];p.bufferToBuffer(l,q,0,l,b,0,n);var r,s,t;for(f=0;f<n;f++)r=l[3*f],s=l[3*f+1],t=l[3*f+2],c[3*(d+f)]=a[0]*r+a[4]*s+a[8]*t+a[12],c[3*
(d+f)+1]=a[1]*r+a[5]*s+a[9]*t+a[13],c[3*(d+f)+2]=a[2]*r+a[6]*s+a[10]*t+a[14]}}return{localTrafo:k,globalTrafo:e}},reprojectBoundingBox:function(c,l,f,d,q){for(var b=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],g=[-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE],a=0;a<c.length/3;a++)for(var k=[c[3*a],c[3*a+1],c[3*a+2]],h=0;3>h;h++)b[h]=Math.min(b[h],k[h]),g[h]=Math.max(g[h],k[h]);a=this.geographicToProjected(l,f,d);e.add(a,b,b);e.add(a,g,g);for(a=0;3>a;a++)g[a]==b[a]&&(g[a]+=1);a=[[b[0],
b[1],b[2]],[g[0],b[1],b[2]],[b[0],g[1],b[2]],[b[0],b[1],g[2]]];for(k=0;4>k;k++)h=a[k],p.vectorToVector(h,d,h,q);d=e.subtract(a[1],a[0],e.create());k=e.subtract(a[2],a[0],e.create());h=e.subtract(a[3],a[0],e.create());e.scale(d,1/(g[0]-b[0]));e.scale(k,1/(g[1]-b[1]));e.scale(h,1/(g[2]-b[2]));var b=e.length(d),g=e.length(k),n=e.length(h);if(3<Math.abs(b-g)||3<Math.abs(b-n)||3<Math.abs(g-n)){for(a=0;a<c.length/3;a++)c[3*a]*=b,c[3*a+1]*=g,c[3*a+2]*=n;e.normalize(d);e.normalize(k);e.normalize(h)}c=m.createFromMatrixRowMajor([d[0],
k[0],h[0],0,d[1],k[1],h[1],0,d[2],k[2],h[2],0,0,0,0,1]);b=[0,0,0,0];p.vectorToVector(l,f,b,q);return{globalTrafo:m.createFromMatrixRowMajor([1,0,0,b[0],0,1,0,b[1],0,0,1,b[2],0,0,0,1]),localTrafo:c}},geographicToProjected:function(c,e,f){return 4326===f.wkid?[c[0],c[1],c[2]]:c}}});