// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../processors/SpatialIndex","../../../../geometry/SpatialReference","../../../../geometry/support/webMercatorUtils"],function(m,n,k,g,h){return function(){function a(){this.spatialIndex=new k;this.spatialIndexNumPendingQueries=this.spatialIndexNumGraphics=0;this.graphicsCore=this.viewSR=this.layer=this.layerView=null}a.prototype.initialize=function(l,a,c,b){this.layerView=l;this.layer=a;this.viewSR=c;this.graphicsCore=b};a.prototype.destroy=function(){this.spatialIndex&&
(this.spatialIndex.destroy(),this.spatialIndex=null);this.graphicsCore=this.layerView=this.viewSR=null};a.prototype.numNodesUpdating=function(){return 0};a.prototype.isUpdating=function(){return 0<this.spatialIndexNumPendingQueries};a.prototype.hasGraphics=function(){return 0<this.spatialIndexNumGraphics};a.prototype.intersects=function(a,e,c){var b=this;this.hasGraphics()&&(this.spatialIndexNumPendingQueries++,this.spatialIndex.intersects(a,void 0,void 0,!0).then(function(a){b.spatialIndexNumPendingQueries--;
c(a.results,a.results.length);b.layerView._evaluateUpdatingState()}))};a.prototype.shouldAddToSpatialIndex=function(a,e,c){return c||e.mustAlignToTerrain()};a.prototype.addGraphicsToSpatialIndex=function(a){if(this.layerView.loadedGraphics)for(var e=this.layerView.loadedGraphics.toArray(),c=e.length,b=0;b<c;b++){var f=e[b],d=this.graphicsCore.getGraphics3DGraphicById(f.id);d&&!d.addedToSpatialIndex&&this.shouldAddToSpatialIndex(f,d,a)&&this.addGraphicToSpatialIndex(f,d)}};a.prototype.addGraphicToSpatialIndex=
function(a,e){var c=a.geometry.spatialReference,b=this.viewSR,f={id:a.id,geometry:null};if(c.equals(b))f.geometry=a.geometry.toJSON();else{var d=void 0;if(c.wkid===g.WGS84.wkid&&b.isWebMercator)d=h.geographicToWebMercator(a.geometry);else if(c.isWebMercator&&b.wkid===g.WGS84.wkid)d=h.webMercatorToGeographic(a.geometry);else return console.warn("Cannot convert graphic geometry to map spatial reference, elevation and scale updates are disabled"),!1;f.geometry=d.toJSON()}this.spatialIndexNumGraphics++;
this.spatialIndex.runProcess([f],this.layer.id);return e.addedToSpatialIndex=!0};return a}()});