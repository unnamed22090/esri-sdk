// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.
//>>built
require({cache:{"url:esri/views/3d/terrain/TerrainMaterial.xml":'\x3c?xml version\x3d"1.0" encoding\x3d"UTF-8"?\x3e\r\n\r\n\x3csnippets\x3e\r\n\r\n\x3csnippet name\x3d"vsTerrain"\x3e\x3c![CDATA[\r\n  precision mediump float;\r\n\r\n  uniform mat4 proj;\r\n  uniform mat4 view;\r\n  uniform vec3 origin;\r\n  uniform vec2 texOffset;\r\n  uniform float texScale;\r\n  uniform mat4 viewNormal;\r\n\r\n  attribute vec3 $position;\r\n  attribute vec2 $uv0;\r\n  varying vec2 vtc;\r\n  varying vec3 vpos;\r\n  varying vec3 vnormal;\r\n\r\n#if defined(WIREFRAME) || defined(TILE_BORDERS)\r\n  varying vec2 vuv;\r\n#endif\r\n\r\n#ifdef ATMOSPHERE\r\n  uniform vec3 lightDirection;\r\n  varying vec3 wpos;\r\n  varying vec3 wview;\r\n  varying vec3 wnormal;\r\n  varying vec3 wlight;\r\n#endif    \r\n\r\n#ifdef OVERLAY\r\n  uniform vec2 overlayTexOffset;\r\n  uniform vec2 overlayTexScale;\r\n  varying vec2 vtcOverlay;\r\n#endif\r\n\r\n  void main(void) {\r\n    vpos \x3d $position;\r\n\r\n#ifdef SPHERICAL\r\n    vnormal \x3d normalize(vpos + origin);\r\n#else\r\n    vnormal \x3d vec3(0, 0, 1); // WARNING: up-axis dependent code\r\n#endif\r\n    \r\n#ifdef ATMOSPHERE    \r\n    wpos \x3d (view * vec4(vpos, 1.0)).xyz;\r\n    wnormal \x3d (viewNormal * vec4(normalize(vpos+origin), 1.0)).xyz;\r\n    wlight \x3d (view  * vec4(lightDirection, 1.0)).xyz;\r\n#endif\r\n\r\n#if defined(WIREFRAME) || defined(TILE_BORDERS)\r\n    vuv \x3d $uv0;\r\n#endif\r\n\r\n    gl_Position \x3d proj * view * vec4(vpos, 1.0);\r\n    vtc \x3d $uv0*texScale + texOffset;\r\n\r\n#ifdef OVERLAY\r\n    vtcOverlay \x3d $uv0*overlayTexScale + overlayTexOffset;\r\n#endif\r\n  }\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"fsTerrainCommon"\x3e\x3c![CDATA[\r\n  uniform vec3 lightDirection;\r\n  uniform vec3 viewDirection;\r\n  uniform sampler2D depthTex;\r\n  uniform int shadowMapNum;\r\n  uniform vec4 shadowMapDistance;\r\n  uniform mat4 shadowMapMatrix[4];\r\n  uniform float depthHalfPixelSz;\r\n  uniform sampler2D ssaoTex;\r\n  uniform vec4 viewportPixelSz;\r\n  uniform sampler2D tex;\r\n  uniform float opacity;\r\n\r\n  varying vec3 vpos;\r\n  varying vec3 vnormal;\r\n  varying vec2 vtc;\r\n\r\n#if defined(WIREFRAME) || defined(TILE_BORDERS)\r\n  varying vec2 vuv;\r\n#endif\r\n\r\n#ifdef ATMOSPHERE\r\n  varying vec3 wpos;\r\n  varying vec3 wview;\r\n  varying vec3 wnormal;\r\n  varying vec3 wlight;\r\n#endif\r\n\r\n  const vec3 ambient \x3d vec3(0.2,0.2,0.2);\r\n  const vec3 diffuse \x3d vec3(0.8,0.8,0.8);\r\n  const float diffuseHardness \x3d 2.5;\r\n\r\n#ifdef OVERLAY\r\n  uniform sampler2D overlayTex;\r\n  uniform float overlayOpacity;\r\n  varying vec2 vtcOverlay;\r\n#endif\r\n\r\n  $evalShadow\r\n\r\n  float lum(vec3 c) {\r\n    float max \x3d max(max(c.r, c.g), c.b);\r\n    float min \x3d min(min(c.r, c.g), c.b);\r\n    return (min + max) * 0.5;\r\n  }\r\n\r\n#ifdef ATMOSPHERE\r\n  vec3 atmosphere(vec3 lightPos, vec3 normal, vec3 view) {\r\n    vec3 surfaceColor   \x3d vec3(0.0);\r\n    vec3 fuzzySpecColor \x3d vec3(1.0);\r\n    vec3 subColor       \x3d vec3(0.0);\r\n    float rollOff       \x3d 1.0;\r\n\r\n    vec3 Ln \x3d normalize(lightPos);\r\n    vec3 Nn \x3d normalize(normal);\r\n    vec3 Hn \x3d normalize(view + Ln);\r\n    \r\n    float ldn \x3d dot(Ln, Nn);\r\n    float diffComp \x3d max(0.0, ldn);\r\n    float vdn \x3d 1.0 - dot(view, Nn);\r\n    float ndv \x3d dot(view, Ln);\r\n    \r\n    vec3 diffContrib \x3d surfaceColor * diffComp;\r\n    float subLamb \x3d max(0.0, smoothstep(-rollOff, 1.0, ldn) - smoothstep(0.0, 1.0, ldn));     \r\n    \r\n    vec3 subContrib \x3d subLamb * subColor;\r\n    vec3 vecColor \x3d vec3(vdn);\r\n    \r\n    vec3 diffuseContrib \x3d (subContrib + diffContrib);\r\n    vec3 specularContrib \x3d (vecColor * fuzzySpecColor);    \r\n\r\n    return (diffContrib + specularContrib) * rollOff;\r\n  }\r\n#endif\r\n\r\n  void main() {\r\n    vec3 a \x3d ambient;\r\n\r\n    float shadow \x3d evalShadow(vpos, 1.0 / gl_FragCoord.w, depthTex, shadowMapNum, shadowMapDistance, shadowMapMatrix, depthHalfPixelSz);\r\n    float vndl \x3d dot(normalize(vnormal), lightDirection);\r\n    float k \x3d smoothstep(0.0, 1.0, clamp(vndl*diffuseHardness, 0.0, 1.0));\r\n    vec3 d \x3d (1.0 - shadow/1.8) * diffuse * k;\r\n\r\n\r\n    float ssao \x3d viewportPixelSz.w \x3c .0 ? 1.0 : texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;\r\n    vec4 texVal \x3d texture2D(tex, vtc);\r\n    vec3 texCol \x3d texVal.rgb;\r\n    float texAlpha \x3d texVal.a;\r\n\r\n#ifdef OVERLAY\r\n    if ((vtcOverlay.x \x3e 0.0) \x26\x26 (vtcOverlay.y \x3e 0.0) \x26\x26 (vtcOverlay.x \x3c 1.0) \x26\x26 (vtcOverlay.y \x3c 1.0)) {\r\n      vec4 overlayTexCol \x3d texture2D(overlayTex, vtcOverlay);\r\n      overlayTexCol *\x3d overlayOpacity;\r\n      texCol \x3d texCol*(1.0-overlayTexCol.a) + overlayTexCol.rgb; // overlayTexCol has pre-multiplied alpha\r\n      texAlpha \x3d overlayTexCol.a + (1.0 - overlayTexCol.a) * texAlpha;\r\n    }\r\n#endif\r\n\r\n    vec3 atm \x3d vec3(0.0);\r\n#ifdef ATMOSPHERE  \r\n    float ndotl \x3d max(0.0, min(1.0, vndl));\r\n    atm \x3d atmosphere(wlight, wnormal, -viewDirection);\r\n    atm *\x3d max(0.0, min(1.0, (1.0-lum(texCol)*1.5))); //avoid atmosphere on bright base maps\r\n    atm *\x3d max(0.0, min(1.0, ndotl*2.0)); // avoid atmosphere on dark side of the globe\r\n#endif\r\n    vec3 color \x3d atm + texCol * (a + d) * ssao;\r\n    gl_FragColor \x3d vec4(color, texAlpha * opacity);\r\n\r\n  // closing } is missing here, it\'s in the shaders using this snippet below\r\n\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"fsTerrainWireframe"\x3e\x3c![CDATA[\r\n#ifdef GL_OES_standard_derivatives\r\n#extension GL_OES_standard_derivatives : enable\r\n#endif\r\n\r\n  precision mediump float;\r\n\r\n  struct WireframeSettings {\r\n    float width;\r\n    float falloff;\r\n    float subdivision;\r\n    vec4 color;\r\n    float wireOpacity;\r\n    float surfaceOpacity;\r\n    float near;\r\n    float far;\r\n  };\r\n\r\n  uniform WireframeSettings wireframe;\r\n\r\n    $fsTerrainCommon\r\n\r\n    vec2 dVuv;\r\n    vec2 vuvScaled \x3d vuv * wireframe.subdivision;\r\n    vec2 vuvMod \x3d fract(vuvScaled);\r\n\r\n#ifdef GL_OES_standard_derivatives\r\n    dVuv \x3d fwidth(vuvScaled);\r\n#else\r\n    // Something that reasonably works\r\n    dVuv \x3d vec2(0.05);\r\n#endif\r\n\r\n    vec2 edgeFactors \x3d smoothstep((wireframe.width - wireframe.falloff) * dVuv,\r\n                                  wireframe.width * dVuv, min(vuvMod, 1.0 - vuvMod));\r\n\r\n    float edgeFactor \x3d 1.0 - min(edgeFactors.x, edgeFactors.y);\r\n\r\n#ifdef WIREFRAME\r\n    gl_FragColor \x3d vec4(mix(gl_FragColor.rgb, wireframe.color.rgb, edgeFactor * wireframe.color.a),\r\n                        mix(wireframe.surfaceOpacity, wireframe.wireOpacity, edgeFactor));\r\n#endif\r\n\r\n\r\n#ifdef TILE_BORDERS\r\n    dVuv \x3d fwidth(vuv);\r\n    edgeFactors \x3d smoothstep((wireframe.width - wireframe.falloff) * dVuv,\r\n                              wireframe.width * dVuv, min(vuv, 1.0 - vuv));\r\n    edgeFactor \x3d 1.0 - min(edgeFactors.x, edgeFactors.y);\r\n\r\n    gl_FragColor \x3d mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);\r\n#endif\r\n  }\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"fsTerrain"\x3e\x3c![CDATA[\r\n  precision mediump float;\r\n\r\n    $fsTerrainCommon\r\n  }\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"vsTerrainNormal"\x3e\x3c![CDATA[\r\n  uniform vec3 origin;\r\n  uniform mat4 proj;\r\n  uniform mat4 view;\r\n  uniform mat4 viewNormal;\r\n  attribute vec3 $position;\r\n  varying vec3 vnormal;\r\n\r\n  void main(void) {\r\n#ifdef SPHERICAL\r\n    vec4 normal \x3d vec4(normalize($position + origin), 1.0);\r\n#else\r\n    vec4 normal \x3d vec4(0.0, 1.0, 0.0, 1.0);\r\n#endif\r\n\r\n    gl_Position \x3d proj * view * vec4($position, 1.0);\r\n    vnormal \x3d normalize((viewNormal * normal).xyz);\r\n  }\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"vsTerrainDepthOnly"\x3e\x3c![CDATA[\r\n  precision mediump float;\r\n\r\n  uniform mat4 proj;\r\n  uniform mat4 view;\r\n\r\n  attribute vec3 $position;\r\n\r\n  void main() {\r\n    gl_Position \x3d proj * view * vec4($position, 1.0);\r\n  }\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"fsTerrainDepthOnly"\x3e\x3c![CDATA[\r\n  precision mediump float;\r\n\r\n  void main() {\r\n  }\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3c/snippets\x3e\r\n'}});
define("dojo/Deferred dojo/when ./TileUtils ./TerrainConst ./TileGeometryFactory ../support/PreallocArray ../support/ObjectPool ../webgl-engine/lib/GLVBO ../webgl-engine/lib/GLIBO ../webgl-engine/lib/ShaderVariations dojo/text!./TerrainMaterial.xml ../webgl-engine/materials/internal/MaterialUtil ../webgl-engine/lib/GLSLProgram ../webgl-engine/lib/Util ../webgl-engine/lib/GLUtil ../lib/glMatrix ../webgl-engine/lib/RenderPass ../webgl-engine/lib/RenderSlot ../webgl-engine/lib/tracer".split(" "),function(Ia,
Ja,E,A,$,Q,ja,ka,Ka,la,La,R,ma,na,oa,u,I,J,aa){var ba=na.assert,x=u.vec2d,k=u.vec3d,pa=u.vec4d,Ma=u.mat4d.identity(),Na=[2,2],qa=J.OPAQUE_TERRAIN,ra=J.TRANSPARENT_TERRAIN,sa=[0,0],ta=k.create(),S,B=R.Layouts.PosTex,ca=x.create(),T=function(){this.overlayTexOffset=x.create();this.texOffset=x.create();this.geometryInfo={geometry:null,numSurfaceIndices:0,numSkirtIndices:0,numWithoutSkirtIndices:0,numVertsPerRow:0};this.init()};T.prototype.init=function(){this.geometryInfo.geometry=null;this.geometryInfo.numSurfaceIndices=
0;this.geometryInfo.numSkirtIndices=0;this.geometryInfo.numWithoutSkirtIndices=0;this.geometryInfo.numVertsPerRow=0;this.textureReference=this.texture=this.ibo=this.vbo=this.geometryState=null;x.set2(0,0,this.texOffset);this.texScale=1;this.overlayTexId=null;this.overlayTexScale=[1,1];this.overlayOpacity=1;this.localOrigin=null};T.prototype.updateGeometryState=function(k){return this.geometryState=k.geometryState(this.geometryState)};u=function(u,v){function J(a,b){var d=a.screenDepth,c=b.screenDepth;
return d<c?-F:d>c?F:0}function Oa(a,b){return 0===a.tiles.length?-F:0===b.tiles.length?F:J(a.tiles.data[0],b.tiles.data[0])}function U(a,b){void 0===b&&(b=e.subdivisionReduceLevels);return 0===b?a:0>b?Math.floor((a-1)*(1<<-b))+1:Math.floor((a-1)/(1<<b))+1}v=v||256;var b,ua,va=!1,q=null,da=null,h=null,wa={},xa=new ja(100,T),m=new Q(10,function(){return{root:null,tiles:new Q(300)}}),y=new E.IteratorPreorder,K,C,ea,D,ya=!0,G=1,fa=!0,e={mode:"none",width:1.5,falloff:1.5,wireOpacity:1,surfaceOpacity:0,
color:[1,1,1,0],subdivision:"geometry",subdivisionReduceLevels:0},H=!1,za=!1,L=!1,F=1,V=!0,Aa=null,W=null,X=null,Ba=null,M=null,Ca=null;this.updateTileBackground=function(a){M&&M.reject();Ca=a;var b=new Ia;M=b;if(a){var d=new Image;d.src=a instanceof Image?a.src:a;d.onload=function(){b.isFulfilled()||b.resolve(d)}}else b.resolve(null);this.renderTileBackground();return b.promise};var Y=0,N=0,ga=0,ha=0;this.numTileTexturesComposited=0;this.castShadows=!1;this.loaded=function(){};var Da=!1;this.needsRender=
!0;this.didRender=!1;var w=new Q(10),O=0,Z=new Q(30),Ea=new ja(10,function(){this.extent=pa.create();this.maxLevel=this.minLevel=0;this.callback=null});this.renderTileBackground=function(){if(b&&M)return M.then(function(a){X=this._buildTexture();a&&oa.texImage2D(a,X,b,null,null,!1,!1,!1);q&&E.traverseTilesPreorder(q,function(a){this.updateTileTexture(a)}.bind(this))}.bind(this))};this.initializeRenderContext=function(a){b=a.gl;C=b.getExtension("EXT_texture_filter_anisotropic")||b.getExtension("MOZ_EXT_texture_filter_anisotropic")||
b.getExtension("WEBKIT_EXT_texture_filter_anisotropic");ba(!S||S===C.TEXTURE_MAX_ANISOTROPY_EXT,"contexts have different definitions afExt.TEXTURE_MAX_ANISOTROPY_EXT");null!=C&&(S=C.TEXTURE_MAX_ANISOTROPY_EXT,ea=b.getParameter(C.MAX_TEXTURE_MAX_ANISOTROPY_EXT),D=Math.min(8,ea));var f=b.getExtension("OES_element_index_uint");$.setSupportsUintIndices(!!f);Ja(this.renderTileBackground(),function(){this.needsRender=va=!0}.bind(this));f=new Float32Array(20);f[0]=-1;f[1]=-1;f[2]=0;f[3]=0;f[4]=0;f[5]=1;
f[6]=-1;f[7]=0;f[8]=1;f[9]=0;f[10]=-1;f[11]=1;f[12]=0;f[13]=0;f[14]=1;f[15]=1;f[16]=1;f[17]=0;f[18]=1;f[19]=1;W=new ka(f,B,b);Aa=b.createFramebuffer();ua=a.textureRep;var f=a.shaderSnippets,d=a.shaderRep;a=a.programRep;f.vsTerrain||f._parse(La);b.getExtension("OES_standard_derivatives");var c=new la("terrain",["vsTerrain","fsTerrain"],null,a,d,f,b);c.addDefine("Spherical","SPHERICAL");c.addDefine("Overlay","OVERLAY");c.addDefine("Atmosphere","ATMOSPHERE");c.addDefine("Wireframe","WIREFRAME");c.addDefine("TileBorders",
"TILE_BORDERS");c.addBinaryShaderSnippetSuffix("Wireframe","Wireframe",[!1,!0]);d=new la("terrainNormal",["vsTerrainNormal","fsNormal"],null,a,d,f,b);d.addDefine("Spherical","SPHERICAL");d.addDefine("AlphaZero","ALPHA_ZERO");h={depth:a.get("depth"),depthShadowMap:a.get("depthShadowMap"),depthOnly:ma.fromSnippets("vsTerrainDepthOnly","fsTerrainDepthOnly",f,b),blendLayers:ma.fromSnippets("vertexShaderBlendLayers","fragmentShaderBlendLayers",f,b)};da={color:c,normal:d};this._updatePrograms();Ba=oa.createEmptyTexture(b)};
this._updatePrograms=function(){var a="spherical"===u,b="shader"===e.mode;h.color=da.color.getProgram([a,!0,a,b,H,b||H]);h.normal=da.normal.getProgram([a,!0])};this.install=function(a){a.addExternalRenderer([qa,ra],this)};this.uninstall=function(a){a.removeExternalRenderer(this)};this.setRootTiles=function(a){q=a};this.setTileSize=function(a){v=a};this.loadTile=function(a){ba(null===a.renderData);a.renderData=xa.acquire();a.renderData.init();var b=this.getLocalOriginOfTile(a),d=a.createGeometry(a.renderData.updateGeometryState(a),
b,"debug"===e.mode,a.renderData.geometryInfo);a.renderData.localOrigin=b;this._setTileGeometry(a,d);this.updateTileTexture(a);this.needsRender=!0};this.queryVisibleLevelRange=function(a,b,d,c){var l=Ea.acquire();pa.set(a,l.extent);l.minLevel=b?b:-Number.MAX_VALUE;l.maxLevel=null!=d?d:Number.MAX_VALUE;l.callback=c;Z.push(l);this.needsRender=!0};this._buildTexture=function(a){var f=b.createTexture();b.bindTexture(b.TEXTURE_2D,f);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE);b.texParameteri(b.TEXTURE_2D,
b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR);D&&b.texParameterf(b.TEXTURE_2D,S,D);if(a)try{b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a)}catch(d){b.texImage2D(b.TEXTURE_2D,0,b.RGBA,v,v,0,b.RGBA,b.UNSIGNED_BYTE,null),console.warn("TerrainRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}else b.texImage2D(b.TEXTURE_2D,0,b.RGBA,v,v,0,b.RGBA,b.UNSIGNED_BYTE,null);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,
b.LINEAR_MIPMAP_LINEAR);b.generateMipmap(b.TEXTURE_2D);return f};this._composeTexture=function(a,f,d){b.activeTexture(b.TEXTURE0);b.bindTexture(b.TEXTURE_2D,a);h.blendLayers.uniform1f("scale",f);h.blendLayers.uniform2fv("offset",d);b.drawArrays(b.TRIANGLE_STRIP,0,W.getNum())};this._composeMapLayers=function(a,f,d,c,l){var P=A.LayerClass.MAP;a.renderData.texture||(a.renderData.texture=this._buildTexture());b.bindFramebuffer(b.FRAMEBUFFER,Aa);b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,
b.TEXTURE_2D,a.renderData.texture,0);b.viewport(0,0,v,v);b.clearColor(0,0,0,0);b.clear(b.COLOR_BUFFER_BIT);b.enable(b.BLEND);b.blendFuncSeparate(b.ONE_MINUS_DST_ALPHA,b.DST_ALPHA,b.ONE_MINUS_DST_ALPHA,b.ONE);h.blendLayers.use();h.blendLayers.uniform1i("tex",0);B.enableVertexAttribArrays(b,h.blendLayers,!1);W.bind();W.setPointers(h.blendLayers);for(var g=0;g<=d;g++){var e=f[g],n=null,r,p;e.data?(n=e,r=sa,p=1):e.upsampleFromTile&&(e=e.upsampleFromTile,n=e.tile.layerInfo[P][g],r=e.offset,p=e.scale);
n&&(n.data instanceof Image&&(n.data=this._buildTexture(n.data)),h.blendLayers.uniform1f("opacity",l[g]),this._composeTexture(n.data,p,r))}c&&this._composeTexture(X,1,sa);b.bindTexture(b.TEXTURE_2D,a.renderData.texture);b.generateMipmap(b.TEXTURE_2D);B.disableVertexAttribArrays(b,h.blendLayers,!1);b.bindFramebuffer(b.FRAMEBUFFER,null);a=b.web3DDefaultState;b.blendFunc(a.blendFuncSrc,a.blendFuncDst);b.disable(b.BLEND);this.numTileTexturesComposited++};var Fa=Array(20);this.updateTileTexture=function(a){for(var b=
a.layerInfo[A.LayerClass.MAP],d=0;d<b.length;d++)b[d].pendingUpdates&=~A.TileUpdateTypes.UPDATE_TEXTURE;if(a.renderData){var c,l=A.LayerClass.MAP,d=a.renderData,e,g=0;for(e=0;e<b.length;e++){c=b[e];var s=a.parentSurface.layerViewByIndex(e,l),n=s.layer.get("opacity");Fa[e]=n;if(c.data||c.upsampleFromTile)if(g++,!s.isTransparent()&&1<=n)break}c=!1;e===b.length&&(c=!0,e--);0===g?(d.textureReference=X,x.set2(0,0,d.texOffset),d.texScale=1):1===g&&!c?(c=b[e],c.data?(b=c,x.set2(0,0,d.texOffset),d.texScale=
1):(a=c.upsampleFromTile,b=a.tile.layerInfo[l][e],x.set(a.offset,d.texOffset),d.texScale=a.scale),b&&(b.data instanceof Image&&(b.data=this._buildTexture(b.data)),d.textureReference=b.data)):(this._composeMapLayers(a,b,e,c,Fa),d.textureReference=null,x.set2(0,0,d.texOffset),d.texScale=1);this.needsRender=!0}};this.releaseTileTexture=function(a){b.deleteTexture(a)};this.releaseTileTextures=function(a){a=a.layerInfo[A.LayerClass.MAP];for(var f=0;f<a.length;f++){var d=a[f];d&&d.data instanceof window.WebGLTexture&&
b.deleteTexture(d.data)}};this.updateTileGeometryNeedsUpdate=function(a){return a.renderData.updateGeometryState(a).needsUpdate};this._updateTileGeometry=function(a){for(var b=a.renderData.geometryState,d=a.layerInfo[A.LayerClass.ELEVATION],c=0;c<d.length;c++)d[c].pendingUpdates&=~A.TileUpdateTypes.UPDATE_GEOMETRY;return b.needsUpdate?(a.renderData.vbo&&this._releaseTileGeometry(a),b=a.createGeometry(b,a.renderData.localOrigin,"debug"===e.mode,a.renderData.geometryInfo),this._setTileGeometry(a,b),
!0):!1};this.updateTileGeometry=function(a){a.renderData.updateGeometryState(a);return this._updateTileGeometry(a)};this.unloadTile=function(a){this._releaseTileGeometry(a);a.renderData.texture&&b.deleteTexture(a.renderData.texture);xa.release(a.renderData);a.renderData=null};this.getLocalOriginOfTile=function(a){if(10<=a.lij[0]){for(;7<a.lij[0];)a=a.parent;return a.centerAtSeaLevel}if("spherical"===u)return ta;for(;a.parent;)a=a.parent;return a.centerAtSeaLevel};this.setVisibility=function(a){ya=
a;this.needsRender=!0};this.getStats=function(){return{numTilesRendered:N,numTilesCulled:ga,numTrianglesRendered:Y,numOriginsRendered:ha}};this.setMaxAnisotropy=function(a){C&&(a=na.clamp(a,1,ea),a!==D&&(D=a,q&&E.traverseTilesPreorder(q,function(a){a.renderData&&a.renderData.texture&&(b.bindTexture(b.TEXTURE_2D,a.renderData.texture),b.texParameterf(b.TEXTURE_2D,C.TEXTURE_MAX_ANISOTROPY_EXT,D))})));this.needsRender=!0};this.getMaxAnisotropy=function(){return D};this.setDisableRendering=function(a){za=
!!a;this.needsRender=!0};this.getOpacity=function(){return G};this.getWireframeEnabled=function(){return"shader"===e.mode};this.setWireframe=function(a){if(!a||!0===a)a={mode:a?"shader":"none"};if(void 0!==a.mode&&e.mode!==a.mode){var b="debug"===e.mode,d="debug"===a.mode;e.mode=a.mode;this._updatePrograms();b!==d&&q&&E.traverseTilesPreorder(q,function(a){if(a.renderData){a.renderData.vbo&&this._releaseTileGeometry(a);var b=a.createGeometry(a.renderData.updateGeometryState(a),a.renderData.localOrigin,
d,a.renderData.geometryInfo);this._setTileGeometry(a,b)}}.bind(this));this.needsRender=!0}for(var c in a)e.hasOwnProperty(c)&&(e[c]=a[c]),this.needsRender=!0};this.setOpacity=function(a){G=a;this.needsRender=!0};this.setDrawSkirts=function(a){fa=a;this.needsRender=!0};this.setCullBackFaces=function(a){L=a;this.needsRender=!0};this.setRenderOrder=function(a){F=a;this.needsRender=!0};this.setBorders=function(a){H!==a&&(H=a,"none"===e.mode&&(e.transitionTime=0),this._updatePrograms(),this.needsRender=
!0)};this.setFrontMostTransparent=function(a){V!==a&&(V=a,this.needsRender=!0)};this.setNeedsRender=function(){this.needsRender=!0;this.didRender=!1};this.resetNeedsRender=function(){this.didRender&&(this.needsRender=0!==Z.length,this.didRender=!1)};var ia=k.create();this.isTransparent=function(){return 1>G||"shader"===e.mode&&(1>e.wireOpacity||1>e.surfaceOpacity)||!Ca};this.render=function(a){if(va&&!za&&ya&&q){var f=this.isTransparent();if(a.slot===(f?ra:qa)){aa.trace("# BEGIN RENDER TERRAIN");
m.clear();K=null;this._renderCollectOrigins();if(0!==F){for(var d=0;d<m.length;d++)this._sortFrontToBack(m.data[d].tiles,J);this._sortFrontToBack(m,Oa)}var c,l=!1,P=!1;c=a.pass;var g=a.camera;if(c===I.MATERIAL){if((P=f)&&V)l=h.depthOnly,l.use(),B.enableVertexAttribArrays(b,l,!1),b.colorMask(!1,!1,!1,!1),this._renderTilesDepthOnly(g,b,l),b.colorMask(!0,!0,!0,!0),b.depthFunc(b.EQUAL),b.depthMask(!1);c=h.color;l=!0;c.use();c.uniform1f("opacity",G);P&&b.enable(b.BLEND);!b.web3DDefaultState.cullEnabled&&
L?b.enable(b.CULL_FACE):b.web3DDefaultState.cullEnabled&&!L&&b.disable(b.CULL_FACE);if("shader"===e.mode||H)c.uniform1f("wireframe.width",e.width),c.uniform1f("wireframe.falloff",Math.min(e.width,e.falloff)),c.uniform1f("wireframe.wireOpacity",e.wireOpacity*G),c.uniform1f("wireframe.surfaceOpacity",e.surfaceOpacity*G),c.uniform4fv("wireframe.color",e.color),c.uniform1f("wireframe.near",g.near),c.uniform1f("wireframe.far",g.far),"geometry"!==e.subdivision&&"constant"!==e.subdivision&&c.uniform1f("wireframe.subdivision",
U(e.subdivision))}else if(c===I.MATERIAL_DEPTH_SHADOWMAP&&this.castShadows||c===I.MATERIAL_DEPTH)c=c===I.MATERIAL_DEPTH_SHADOWMAP?h.depthShadowMap:h.depth,c.use(),c.uniformMatrix4fv("model",Ma),ca[0]=g.near,ca[1]=g.far,c.uniform2fv("nearFar",ca);else if(c===I.MATERIAL_NORMAL)c=h.normal,c.use();else return;a.shadowMap&&a.shadowMap.bind(c);a.ssaoHelper&&a.ssaoHelper.setUniforms(c);B.enableVertexAttribArrays(b,c,!1);l&&(c.uniform1i("tex",4),c.uniform1i("overlayTex",5));c.uniformMatrix4fv("viewNormal",
g.viewInverseTransposeMatrix);c.uniformMatrix4fv("proj",g.projectionMatrix);c.uniform3fv("lightDirection",a.lightingData.direction);g=g.viewMatrix;k.set3(g[12],g[13],g[14],ia);k.normalize(ia);c.uniform3fv("viewDirection",ia);for(ha=Y=ga=N=0;w.length<w.data.length&&0<Z.length;)d=Z.pop(),w.push(d);O=w.length;for(d=0;d<m.length;d++){var s=m.data[d];c.uniform3fv("origin",s.origin);R.bindView(s.origin,g,c);a.shadowMap&&a.shadowMap.bindView(c,s.origin);ha++;this._renderTiles(s.tiles,c,l)}B.disableVertexAttribArrays(b,
c,!1);b.activeTexture(b.TEXTURE0);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null);P&&b.disable(b.BLEND);f&&V&&(b.depthFunc(b.LESS),b.depthMask(!0));!b.web3DDefaultState.cullEnabled&&L?b.disable(b.CULL_FACE):b.web3DDefaultState.cullEnabled&&!L&&b.enable(b.CULL_FACE);for(a=0;a<w.length;a++)f=w.data[a],Ea.release(f),f.callback(a>=O),f.callback=null;w.clear();0<N&&!Da&&(Da=!0,this.loaded&&this.loaded());aa.trace("# END RENDER TERRAIN");return!0}}};this._renderCollectOrigins=function(){for(var a=0;a<q.length;a++){var b=
q[a],d=m.next();d.root=b;d.origin="spherical"===u?ta:b.centerAtSeaLevel;d.tiles.clear();this._renderCollectOriginsForRoot(d)}};this._renderCollectOriginsForRoot=function(a){for(y.reset(a.root);!y.done;){var b=y.next(),d=b.renderData;if(d&&!b.visible)ga++,y.skip();else{var c=m.peek();if(7===b.lij[0]){if(c===a||0!==c.tiles.length)c=m.next(),c.tiles.clear();c.root=b;c.origin=b.centerAtSeaLevel}if(d){d=b.lij[0];10<=d?m.peek().tiles.push(b):a.tiles.push(b);if(null===K||K.lij[0]<d)K=b;y.skip()}}}};this._sortFrontToBack=
function(a,b){a.sort(b)};this._renderTilesDepthOnly=function(a,b,d){var c=a.viewMatrix;d.uniformMatrix4fv("proj",a.projectionMatrix);for(a=0;a<m.length;a++){var e=m.data[a];d.uniform3fv("origin",e.origin);R.bindView(e.origin,c,d);for(var h=0;h<e.tiles.length;h++){var g=e.tiles.data[h].renderData;g.vbo.bind();g.vbo.setPointers(d);var s=g.ibo;s.bind();var n=s.getNum();fa||(n=g.geometryInfo.numWithoutSkirtIndices);b.drawElements(b.TRIANGLES,n,s.getType(),0)}}};this._renderTiles=function(a,f,d){if(0!==
a.length){var c=b.TRIANGLES;"debug"===e.mode&&(c=b.LINES);var l="geometry"===e.subdivision,h="constant"===e.subdivision,g=K,s;g?(s=g.lij[0],g=U(g.renderData.geometryInfo.numVertsPerRow)):g=s=16;for(var n=0;n<a.length;n++){var r=a.data[n],p=r.renderData;aa.trace("# RENDER TILE "+r.lij[0]+"/"+r.lij[1]+"/"+r.lij[2]+", screenDepth:"+r.screenDepth);p.vbo.bind();p.vbo.setPointers(f);var z=p.ibo;z.bind();if(d){f.uniform2fv("texOffset",p.texOffset);f.uniform1f("texScale",p.texScale);b.activeTexture(b.TEXTURE0+
4);b.bindTexture(b.TEXTURE_2D,p.textureReference||p.texture);if(p.overlayTexId){var t=f,k=p,q=k.overlayTexId,m=wa[q];m||(m=ua.aquire(q),ba(m),wa[q]=m);t.uniform2fv("overlayTexOffset",k.overlayTexOffset);t.uniform2fv("overlayTexScale",k.overlayTexScale);t.uniform1f("overlayOpacity",k.overlayOpacity);b.activeTexture(b.TEXTURE0+4+1);b.bindTexture(b.TEXTURE_2D,m)}else f.uniform2fv("overlayTexOffset",Na),t=Ba,b.activeTexture(b.TEXTURE0+4+1),b.bindTexture(b.TEXTURE_2D,t);if(("shader"===e.mode||H)&&(l||
h))l?f.uniform1f("wireframe.subdivision",U(p.geometryInfo.numVertsPerRow)):(t=U(g,r.lij[0]-s),f.uniform1f("wireframe.subdivision",t))}t=z.getNum();fa||(t=p.geometryInfo.numWithoutSkirtIndices);b.drawElements(c,t,z.getType(),0);r.renderOrder=N;N++;Y+=t/3;p=r.extent;r=r.lij[0];for(z=0;z<O;)t=w.data[z],k=t.extent,r>=t.minLevel&&r<=t.maxLevel&&k[0]<=p[2]&&k[2]>=p[0]&&k[1]<=p[3]&&k[3]>=p[1]?(w.swap(z,O-1),O--):z++}}};var Pa=k.create(),Ga=k.create(),Ha=k.create();this.intersect=function(a,b,d,c){if(q&&
!("select"===a.mode&&this.isTransparent())){k.subtract(d,b,Pa);var e=a.getMinResult(),h=a.getMaxResult();for(y.reset(q);!y.done;){var g=y.next();if(null!==g.renderData&&g.visible){var m=g.renderData.geometryInfo.geometry,n=g.renderData.localOrigin;k.subtract(b,n,Ga);k.subtract(d,n,Ha);R.intersectTriangleGeometry(m,0,void 0,c,b,d,Ga,Ha,void 0,a.tolerance,function(a,b){if(0<=a){var c;if(void 0===e.dist||a<e.dist)c=E.lij2str(g.lij[0],g.lij[1],g.lij[2]),e.set(void 0,c,a,b,void 0),e.setIntersector("terrain");
if(void 0===h.dist||a>h.dist)c=E.lij2str(g.lij[0],g.lij[1],g.lij[2]),h.set(void 0,c,a,b,void 0),h.setIntersector("terrain")}})}}}};this._setTileGeometry=function(a,e){var d=a.renderData,c=e.geometry.getData(),h=c.getVertexAttr().terrain.data;d.vbo=new ka(h,B,b);c=c.getFaces()[0].indices.terrain;d.ibo=new Ka(c,b);d.geometryInfo.geometry&&$.releaseGeometry(d.geometryInfo.geometry);d.geometryInfo=e;this.needsRender=!0};this._releaseTileGeometry=function(a){a=a.renderData;a.vbo.dispose();a.ibo.dispose();
a.vbo=null;a.ibo=null;a.geometryInfo.geometry&&$.releaseGeometry(a.geometryInfo.geometry);a.geometryInfo.geometry=null;this.needsRender=!0}};u.TileRenderData=T;return u});