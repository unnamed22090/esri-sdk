// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.
//>>built
define("require exports ./RenderContext ../../../core/watchUtils ../../../core/Collection ../webgl-engine/lib/RenderSlot ../webgl-engine/lib/RenderPass ../webgl-engine/lib/gl-matrix ../webgl-engine/lib/GLSLProgram".split(" "),function(g,r,k,l,h,e,m,n,p){var f=n.vec3d;g=function(){function b(){this._renderers=new h}b.prototype.add=function(a,c){this._findOrCreateStageRenderer(a).add(c)};b.prototype.remove=function(a,c){var d=this._findStageRenderer(a);d&&d.remove(c);0===d.renderers.length&&(d.destroy(),
this._renderers.remove(d))};b.prototype._findStageRenderer=function(a){return this._renderers.find(function(c){return c.view===a})};b.prototype._findOrCreateStageRenderer=function(a){var c=this._findStageRenderer(a);c||(c=new q(a),this._renderers.add(c));return c};return b}();var q=function(){function b(a){var c=this;this.view=a;this.didRender=!0;this.needsDepthMap=this.needsRender=!1;this.renderers=new h;this._readyWatchHandle=l.init(a,"ready",function(a){a?(c.context=new k(c.view),c.view._stage.addExternalRenderer([e.OPAQUE_EXTERNAL,
e.TRANSPARENT_EXTERNAL],c)):(c.renderers.forEach(function(a){a.dispose(c.context)}),c.context=null)})}b.prototype.destroy=function(){var a=this;this.renderers.drain(function(c){a.context&&c.dispose(a.context)});this.view._stage&&this.view._stage.removeExternalRenderer(this);this._readyWatchHandle&&(this._readyWatchHandle.remove(),this._readyWatchHandle=null);this.context=null};b.prototype.add=function(a){-1!==this.renderers.indexOf(a)?console.warn("Cannot add external renderer: renderer has already been added"):
(this.renderers.add(a),this.context&&(a.setup(this.context),this.view._stage.setNeedsRender()))};b.prototype.remove=function(a){var c=this.renderers.indexOf(a);-1!==c&&(this.renderers.removeAt(c),this.context&&(a.dispose(this.context),this.view._stage.setNeedsRender()))};b.prototype.initializeRenderContext=function(a){var c=this;this.context.gl=a.gl;this.renderers.forEach(function(a){a.setup(c.context)})};b.prototype.render=function(a){var c=this;if(a.pass!==m.MATERIAL)return!0;this._updateContext(a);
this.renderers.forEach(function(b){switch(a.slot){case e.OPAQUE_EXTERNAL:b.render&&b.render(c.context);break;case e.TRANSPARENT_EXTERNAL:b.renderTransparent&&b.renderTransparent(c.context)}});var b=this.context.gl;b.web3DDefaultState.apply();b.enable(b.DEPTH_TEST);b.disable(b.BLEND);p.unuse(b);b.activeTexture(b.TEXTURE0);return!0};b.prototype.resetNeedsRender=function(){};b.prototype._updateContext=function(a){this.context.camera.copyFrom(a.camera);f.set(a.lightingData.direction,this.context.sunLight.direction);
f.set(a.lightingData.diffuse,this.context.sunLight.diffuse.color);f.set(a.lightingData.ambient,this.context.sunLight.ambient.color);this.context.sunLight.diffuse.intensity=a.lightingData.diffuse[3];this.context.sunLight.ambient.intensity=a.lightingData.ambient[3]};return b}();return g});