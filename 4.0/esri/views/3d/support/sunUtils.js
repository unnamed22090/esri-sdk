// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.
//>>built
define(["./mathUtils","../lib/glMatrix","../lib/SunCalc"],function(G,t,u){var m=t.vec3d,l=t.mat4d,H=G.lerp,K=l.identity(),n={azimuth:0,altitude:0},f={ambient:{color:m.create(),intensity:0},diffuse:{color:m.create(),intensity:0,direction:m.create()}},B={settings:{local:{altitude:2E3,ambientAtNight:0.2,ambientAtNoon:0.75,ambientAtTwilight:0.5,diffuseAtNoon:0.25,diffuseAtTwilight:0.5},global:{altitude:2E4,ambient:0.5,diffuse:0.5}},computeDirection:function(e,f,h,a){a||(a=m.create());var c=l.identity(K);
"global"===h?(u.getPosition(e,0,0,n),m.set3(0,0,-1,a),l.rotateX(c,-n.azimuth),l.rotateY(c,-n.altitude)):(u.getPosition(e,f.y,f.x,n),m.set3(0,-1,0,a),l.rotateZ(c,-n.azimuth),l.rotateX(c,-n.altitude));l.multiplyVec3(c,a);return a},computeColorAndIntensity:function(l,n){var h,a,c,g=n.z;a=B.settings;m.set3(1,1,1,f.ambient.color);f.ambient.intensity=a.global.ambient;m.set3(1,1,1,f.diffuse.color);f.diffuse.intensity=a.global.diffuse;g=(g-a.local.altitude)/(a.global.altitude-a.local.altitude);g=G.clamp(g,
0,1);if(1>g){c=u.getTimes(l,n.y,n.x);a=l.valueOf();var k,d;c.polarException===u.POLAR_EXCEPTION.MIDNIGHT_SUN?(k=a-36E5*(l.getHours()+48)-6E4*l.getMinutes(),d=k+432E6):c.polarException===u.POLAR_EXCEPTION.POLAR_NIGHT?(k=a-2,d=a-1):(k=c.sunrise.valueOf(),d=c.sunset.valueOf());var p=d-k;c=k+p/2;var q=p/4;h=c-q;var q=c+q,b=0.06*p,p=k-b/2;k+=b/2;var s=d-b/2,C=d+b/2;d=B.settings.local;var D=[0.01,d.ambientAtNight],E=[0.8,0.8,1],F=[0.01,0.01,0.01],v=[d.diffuseAtTwilight,d.ambientAtTwilight],w=[1,0.75,0.75],
x=[0.8,0.8,1],y=[0.9*d.diffuseAtNoon,d.ambientAtNoon],z=[1,0.98,0.98],A=[0.98,0.98,1],t=[d.diffuseAtNoon,d.ambientAtNoon],I=[1,1,1],J=[1,1,1];d=[0,0];var r=[0,0],b=[0,0];a<p||a>C?(d=D,r=F,b=E):a<k?(b=k-p,d=e(a-p,b,D,v),r=e(a-p,b,F,w),b=e(a-p,b,E,x)):a<h?(b=h-k,d=e(a-k,b,v,y),r=e(a-k,b,w,z),b=e(a-k,b,x,A)):a<c?(b=c-h,d=e(a-h,b,y,t),r=e(a-h,b,z,I),b=e(a-h,b,A,J)):a<q?(b=q-c,d=e(a-c,b,t,y),r=e(a-c,b,I,z),b=e(a-c,b,J,A)):a<s?(b=s-q,d=e(a-q,b,y,v),r=e(a-q,b,z,w),b=e(a-q,b,A,x)):a<C&&(b=C-s,d=e(a-s,b,v,
D),r=e(a-s,b,w,F),b=e(a-s,b,x,E));a=d[0];c=r;h=d[1];m.lerp(b,f.ambient.color,g,f.ambient.color);f.ambient.intensity=H(h,f.ambient.intensity,g);m.lerp(c,f.diffuse.color,g,f.diffuse.color);f.diffuse.intensity=H(a,f.diffuse.intensity,g)}return f}},e=function(e,f,h,a){for(var c=[],g=0;g<h.length;g++)c[g]=(a[g]-h[g])*e/f+h[g];return c};return B});