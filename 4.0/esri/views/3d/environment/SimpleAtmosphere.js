// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.
//>>built
require({cache:{"url:esri/views/3d/environment/materials/SimpleAtmosphereMaterial.xml":'\x3c?xml version\x3d"1.0" encoding\x3d"UTF-8"?\x3e\r\n\r\n\x3csnippets\x3e\r\n\r\n\x3csnippet name\x3d"vsSimpleAtmosphere"\x3e\x3c![CDATA[\r\n  uniform mat4 proj;\r\n  uniform mat4 view;\r\n\r\n#ifndef PANORAMIC\r\n\r\n  const float TWICEPI \x3d 2.0*3.14159265;\r\n  const float ATMOSPHERE_RIM_SEGMENTS \x3d 128.0;\r\n\r\n  uniform vec3 silCircleCenter;\r\n  uniform vec3 silCircleV1;\r\n  uniform vec3 silCircleV2;\r\n  uniform vec2 texV;\r\n\r\n#endif\r\n\r\n  uniform vec3 lightDirection;\r\n\r\n  attribute vec3 $position;\r\n  varying vec2 vtc;\r\n  varying float falloff;\r\n\r\n  void main(void) {\r\n\r\n#ifdef PANORAMIC\r\n\r\n    vec3 pos \x3d $position;\r\n    float ndotl \x3d lightDirection.z;\r\n    vtc \x3d vec2(0, $position.z+0.05);\r\n\r\n#else\r\n\r\n    float phi \x3d $position.x * (TWICEPI / ATMOSPHERE_RIM_SEGMENTS) + 1.0;\r\n    vec3 pos \x3d (sin(phi) * silCircleV1 + cos(phi) * silCircleV2 + silCircleCenter) * $position.y;\r\n    float ndotl \x3d dot(normalize(pos), lightDirection);\r\n\r\n    vtc.x \x3d $position.x / ATMOSPHERE_RIM_SEGMENTS;\r\n    vtc.y \x3d texV.x * (1.0 - $position.z) + texV.y * $position.z;\r\n\r\n#endif\r\n\r\n    falloff \x3d max(0.0, (smoothstep(-1.0, 0.8, ndotl + ndotl)));\r\n\r\n    gl_Position \x3d proj * view * vec4(pos, 1.0);\r\n    gl_Position.z \x3d gl_Position.w; // project atmosphere onto the far plane\r\n  }\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"fsSimpleAtmosphere"\x3e\x3c![CDATA[\r\n  precision mediump float;\r\n\r\n  uniform sampler2D tex;\r\n  uniform vec4 color;\r\n  varying vec2 vtc;\r\n  varying float falloff;\r\n\r\n  void main() {\r\n    vec4 texColor \x3d texture2D(tex, vtc);\r\n    gl_FragColor \x3d texColor * color * falloff;\r\n  }\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3c/snippets\x3e\r\n'}});
define("dojo/text!./materials/SimpleAtmosphereMaterial.xml dojo/Deferred ../../../core/watchUtils ../support/ExternalRenderer ../lib/glMatrix ../webgl-engine/lib/GeometryRenderer ../webgl-engine/lib/VertexBufferLayout ../webgl-engine/lib/Texture ../webgl-engine/lib/Util ../webgl-engine/lib/GLSLProgram ../webgl-engine/lib/GLTextureRep ../webgl-engine/lib/RenderPass ../webgl-engine/lib/RenderSlot ./resources/SimpleAtmosphereTexture ../support/earthUtils".split(" "),function(w,x,y,z,q,A,B,C,m,t,D,E,
F,G,H){var l=H.earthRadius,e=q.vec3d,u=q.vec2d,v=q.mat4d,r=m.VertexAttrConstants,I=(l-1E4)/l,s=(l+3E5)/l,n=-1E4/3E5,p=1-n;return z.createSubclass({declaredClass:"esri.views.3d.environment.SimpleAtmosphere",classMetadata:{properties:{view:{},slot:{value:F.BACKGROUND,setter:function(a){this.needsRender=!0;return a}}}},constructor:function(){this._renderData={texV:u.create(),silCircleCenter:e.create(),silCircleV1:e.create(),silCircleV2:e.create()};this._textureRep=this._texture=null},initialize:function(){this._textureDfd=
new x;this.addResolvingPromise(this._textureDfd.promise)},destroy:function(){this._currentViewChangedHandle&&(this._currentViewChangedHandle.remove(),this._currentViewChangedHandle=null);this._textureRep&&(this._texture&&(this._textureRep.release("SimpleAtmosphere"),this._textureRep.getTexture("SimpleAtmosphere").unload()),this._textureRep=null);this._program&&(this._program.dispose(),this._program=null);this._textureDfd&&(this._textureDfd.cancel(),this._textureDfd=null)},initializeRenderContext:function(a){this._textureRep=
new D({SimpleAtmosphere:new C(G,"SimpleAtmosphere",{wrapClamp:!0})},a.programRep,function(){return this.view._stage.getCamera().viewport}.bind(this),a.gl);this._texture=this._textureRep.aquire("SimpleAtmosphere",void 0,void 0,function(){this._textureDfd.resolve();this._textureDfd=null}.bind(this))},setup:function(a){var b=this._createRibbonGeometryData();this._renderer=new A(b,B.Defaults.Pos,null,a.gl);this._currentViewChangedHandle=y.on(this,"view.navigation","currentViewChanged",function(a){this._update(a.camera)}.bind(this),
function(){this._update(this.get("view.navigation.currentCamera"))}.bind(this));a.shaderSnippets.vsSimpleAtmosphere||a.shaderSnippets._parse(w);this._program=t.fromSnippets("vsSimpleAtmosphere","fsSimpleAtmosphere",a.shaderSnippets,a.gl)},render:function(a){if(a.slot!==this.slot||a.pass!==E.MATERIAL)return!1;var b=this.renderContext.gl,c=this._program;c.use();c.uniform4f("color",1,1,1,1);c.uniformMatrix4fv("proj",a.camera.projectionMatrix);c.uniformMatrix4fv("view",a.camera.viewMatrix);c.uniform3fv("silCircleCenter",
this._renderData.silCircleCenter);c.uniform3fv("silCircleV1",this._renderData.silCircleV1);c.uniform3fv("silCircleV2",this._renderData.silCircleV2);c.uniform2fv("texV",this._renderData.texV);b.bindTexture(b.TEXTURE_2D,this._texture);c.uniform1i("tex",0);c.uniform3fv("lightDirection",a.lightingData.direction);b.web3DDefaultState.depthFunc!==b.LEQUAL&&b.depthFunc(b.LEQUAL);b.depthMask(!1);b.enable(b.BLEND);this._renderer.render(this._program);t.unuse(b);b.depthMask(!0);b.disable(b.BLEND);b.web3DDefaultState.depthFunc!==
b.LEQUAL&&b.depthFunc(b.web3DDefaultState.depthFunc);return!0},_update:function(a){if(!(e.length(a.eye)<=l)){var b=e.create(),c=e.create(),d=e.create(),g=this.view.renderCoordsHelper.getAltitude(a.eye);e.scale(a.eye,(l+50)/e.length(a.eye),d);this._computeSilhouetteCircle(d,a.center,a.up,l);e.add(this._renderData.silCircleCenter,this._renderData.silCircleV2,b);e.scale(b,s,c);var d=this._computeScreenRimWidth(d,a.up,b,c),h=0,k=1,f=1;50>g?(h=0.001953125,k=0.1015625):500>g?(f=(g-50)/450,h=0.001953125*
(1-f)+0.001953125*f,k=0.1015625*(1-f)+0.21875*f):5E3>g?(f=(g-500)/4500,h=0.001953125*(1-f)+0.001953125*f,k=0.21875*(1-f)+0.51171875*f):5E4>g&&(f=(g-5E3)/45E3,h=0.001953125*(1-f)+0.001953125*f,k=0.51171875*(1-f)+0.4140625*f);g=n+h*p;f=n+d*k*p;50<e.length(a.eye)-l&&(this._computeSilhouetteCircle(a.eye,a.center,a.up,l),e.add(this._renderData.silCircleCenter,this._renderData.silCircleV2,b),e.scale(b,s,c),a=this._computeScreenRimWidth(a.eye,a.up,b,c),a=m.clamp((a-1.5)/(d-1.5),0,1),g=n+a*h*p,f=n+m.lerp(1,
d*k,a)*p);u.set2(g,f,this._renderData.texV);this.needsRender=!0}},_computeSilhouetteCircle:function(a,b,c,d){var g=e.length(a),h=Math.sqrt(g*g-d*d),h=d*h/g;d=Math.sqrt(d*d-h*h);var k=this._renderData.silCircleV1,f=this._renderData.silCircleV2;e.scale(a,d/g,this._renderData.silCircleCenter);e.cross(a,b,k);1>e.length2(k)&&e.cross(a,c,k);e.scale(k,h/e.length(k));e.cross(k,a,f);e.scale(f,h/e.length(f));return h},_computeScreenRimWidth:function(a,b,c,d){var g=v.create();v.lookAt(a,c,b,g);a=this.view.navigation.currentCamera;
m.project(c,g,a.projectionMatrix,a.viewport);m.project(d,g,a.projectionMatrix,a.viewport);return e.dist(c,d)/a.height},_createRibbonGeometryData:function(){for(var a=new Float32Array(768),b=new Uint32Array(768),c=0;128>c;c++){var d=6*c;a[d+0]=c;a[d+1]=I;a[d+2]=0;a[d+3]=c;a[d+4]=s;a[d+5]=1;var e=2*c,h=127===c?0:e+2;b[d+0]=e;b[d+1]=e+1;b[d+2]=h+1;b[d+3]=h+1;b[d+4]=h;b[d+5]=e}c={};c[r.POSITION]=b;b={};b[r.POSITION]={size:3,data:a};return{faces:{type:"triangle",indices:c,positionKey:r.POSITION},vertexAttr:b}}})});