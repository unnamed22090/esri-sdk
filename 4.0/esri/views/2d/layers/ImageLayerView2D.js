// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.
//>>built
define("dojo/sniff ./LayerView2D ../engine/Bitmap ../../../core/declare ../../../core/watchUtils ../../../core/HandleRegistry ../../../Graphic".split(" "),function(d,e,f,g,h,k,l){var m=d("ie");return g(e,{declaredClass:"esri.views.2d.layers.ImageLayerView2D",classMetadata:{properties:{context:{},pixelData:{}}},constructor:function(){this._hdls=new k;this._hdls.add([h.watch(this,"view.state.version, view.stationary, suspended, layer.exportImageServiceParameters.version",this.refresh.bind(this))])},
initialize:function(){this._createCanvas();this.layer&&this._hdls.add(this.layer.on("redraw",this.redraw.bind(this)))},destroy:function(){this.clear();this.container.removeAllChildren();this._canvas&&(this._canvas=this.context=null);this._hdls.remove();this._hdls.destroy()},context:null,_canvas:null,_rawPixelData:null,refresh:function(){if(this.view.stationary&&!this.suspended){var b=this.view.state;this._imagePromise&&(this._imagePromise.cancel(),this._imagePromise=null);this.updating=!0;this._imagePromise=
this.layer.fetchImage({extent:b.extent,width:b.width,height:b.height}).then(function(a){this._imagePromise=null;this._rawPixelData=a.pixelData;this.pixelData=this.layer.applyFilter(this._rawPixelData);this._drawImage(this.pixelData,b)}.bind(this)).otherwise(function(a){"cancel"!==a.dojoType&&(this.container.removeAllChildren(),this._imagePromise=null,this.emit("error",a),console.error(a))}.bind(this)).always(function(){this.updating=!1}.bind(this))}},redraw:function(){this.view.stationary&&(!this.suspended&&
this._rawPixelData)&&(this.pixelData=this.layer.applyFilter(this._rawPixelData),this._drawImage(this.pixelData,this.view.state))},clear:function(){var b=this.get("view.state");this.context&&"2d"===this.layer.drawType&&this.context.clearRect(0,0,b.width,b.height)},hitTest:function(b,a){var c=this.view.toMap({x:b,y:a});return new l({attributes:{},geometry:c})},_drawImage:function(b,a){if(this.view.stationary&&!this.suspended){this._drawPixelData(b);var c=new f({coords:[a.extent.center.x,a.extent.center.y],
resolution:a.extent.width/a.width,size:[0.5*a.width,0.5*a.height],source:this._canvas,rotation:0});this.container.removeAllChildren();this.container.addChild(c)}},_drawPixelData:function(b){var a=this.get("view.state"),c=this.context;!c||!b||!b.pixelBlock||11>m?this.clear():"2d"===this.layer.drawType&&(this._canvas.width=a.width,this._canvas.height=a.height,a=b.pixelBlock,b=c.createImageData(a.width,a.height),a=a.getAsRGBA(),b.data.set(a),c.putImageData(b,0,0))},_createCanvas:function(){var b=this.get("view.state"),
a=this._canvas=document.createElement("canvas");a.style["transform-origin"]="left top";a.width=b.width;a.height=b.height;this.context=a.getContext(this.layer.drawType);if(!this.context)throw Error("Unable to create the context. This browser might not support \x3ccanvas\x3e elements.");}})});